{% extends "base.html" %}

{% block title %}Actual vs Simulated Inventory Comparison{% endblock %}

{% block content %}
<style>
    .metric-line {
        padding: 12px 16px;
        border-bottom: 1px solid #eee;
        border-radius: 6px;
        margin-bottom: 4px;
        transition: all 0.3s ease;
        position: relative;
    }
    .metric-line:last-child {
        border-bottom: none;
        margin-bottom: 0;
    }
    .metric-line:hover {
        background-color: #f8f9fa;
        transform: translateX(4px);
    }
    .actual-value {
        color: #28a745;
        font-weight: 500;
    }
    .simulated-value {
        color: #007bff;
        font-weight: 500;
    }
    .difference-value {
        font-weight: 500;
    }
    .simulation-better {
        background: linear-gradient(135deg, #e8f5e8 0%, #f0f8ff 100%);
        border-left: 4px solid #28a745;
        box-shadow: 0 2px 4px rgba(40, 167, 69, 0.1);
    }
    .simulation-better::before {
        content: "✓";
        position: absolute;
        right: 16px;
        top: 50%;
        transform: translateY(-50%);
        color: #28a745;
        font-weight: bold;
        font-size: 16px;
        background: white;
        border-radius: 50%;
        width: 24px;
        height: 24px;
        display: flex;
        align-items: center;
        justify-content: center;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .actual-better {
        background: linear-gradient(135deg, #fff5f5 0%, #fff8e8 100%);
        border-left: 4px solid #dc3545;
        box-shadow: 0 2px 4px rgba(220, 53, 69, 0.1);
    }
    .actual-better::before {
        content: "✗";
        position: absolute;
        right: 16px;
        top: 50%;
        transform: translateY(-50%);
        color: #dc3545;
        font-weight: bold;
        font-size: 16px;
        background: white;
        border-radius: 50%;
        width: 24px;
        height: 24px;
        display: flex;
        align-items: center;
        justify-content: center;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .metric-label {
        font-weight: 600;
        color: #495057;
        margin-right: 8px;
    }
    .metric-comparison {
        display: flex;
        align-items: center;
        gap: 8px;
    }
    .comparison-separator {
        color: #6c757d;
        font-weight: 300;
    }
    .performance-indicator {
        font-size: 12px;
        padding: 2px 8px;
        border-radius: 12px;
        font-weight: 500;
        margin-left: 8px;
    }
    .performance-better {
        background-color: #d4edda;
        color: #155724;
    }
    .performance-worse {
        background-color: #f8d7da;
        color: #721c24;
    }
</style>
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <h2 class="mb-4">Actual vs Simulated Inventory Comparison</h2>
            <p class="text-muted">Comprehensive comparison of actual inventory performance vs simulated inventory performance</p>
        </div>
    </div>

    {% if error %}
    <div class="alert alert-danger" role="alert">
        {{ error }}
    </div>
    {% else %}
    
    <!-- Filter Section -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">Filters</h5>
                </div>
                <div class="card-body">
                    <form id="comparisonForm">
                        <div class="row">
                            <div class="col-md-3">
                                <label for="products" class="form-label">Products</label>
                                <select class="form-select" id="products" name="products" multiple>
                                    {% for product in products %}
                                    <option value="{{ product }}" selected>{{ product }}</option>
                                    {% endfor %}
                                </select>
                                <small class="form-text text-muted">Hold Ctrl/Cmd to select multiple</small>
                            </div>
                            <div class="col-md-3">
                                <label for="locations" class="form-label">Locations</label>
                                <select class="form-select" id="locations" name="locations" multiple>
                                    {% for location in locations %}
                                    <option value="{{ location }}" selected>{{ location }}</option>
                                    {% endfor %}
                                </select>
                                <small class="form-text text-muted">Hold Ctrl/Cmd to select multiple</small>
                            </div>
                            <div class="col-md-3">
                                <label for="forecast_methods" class="form-label">Forecast Methods</label>
                                <select class="form-select" id="forecast_methods" name="forecast_methods" multiple>
                                    {% for method in forecast_methods %}
                                    <option value="{{ method }}" selected>{{ method }}</option>
                                    {% endfor %}
                                </select>
                                <small class="form-text text-muted">Hold Ctrl/Cmd to select multiple</small>
                            </div>
                            <div class="col-md-3 d-flex align-items-end">
                                <button type="submit" class="btn btn-primary w-100">Generate Comparison</button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Loading Section -->
    <div class="loading" id="loading" style="display: none;">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
        <p class="mt-2">Generating inventory comparison...</p>
    </div>

    <!-- Results Section -->
    <div id="resultsContainer" style="display: none;">
        
        <!-- Overall Performance Summary -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">Overall Performance Summary</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="metric-line" id="service-level-line">
                                    <div class="metric-comparison">
                                        <span class="metric-label">Service Level:</span>
                                        <span class="actual-value" id="actual-service-level">-</span>
                                        <span class="comparison-separator">|</span>
                                        <span class="simulated-value" id="simulated-service-level">-</span>
                                        <span class="performance-indicator" id="service-level-indicator"></span>
                                    </div>
                                </div>
                                <div class="metric-line" id="stockout-rate-line">
                                    <div class="metric-comparison">
                                        <span class="metric-label">Stockout Rate:</span>
                                        <span class="actual-value" id="actual-stockout-rate">-</span>
                                        <span class="comparison-separator">|</span>
                                        <span class="simulated-value" id="simulated-stockout-rate">-</span>
                                        <span class="performance-indicator" id="stockout-rate-indicator"></span>
                                    </div>
                                </div>
                                <div class="metric-line" id="inventory-days-line">
                                    <div class="metric-comparison">
                                        <span class="metric-label">Inventory Days:</span>
                                        <span class="actual-value" id="actual-inventory-days">-</span>
                                        <span class="comparison-separator">|</span>
                                        <span class="simulated-value" id="simulated-inventory-days">-</span>
                                        <span class="performance-indicator" id="inventory-days-indicator"></span>
                                    </div>
                                </div>
                                <div class="metric-line" id="missed-demand-line">
                                    <div class="metric-comparison">
                                        <span class="metric-label">Missed Demand:</span>
                                        <span class="actual-value" id="actual-missed-demand">-</span>
                                        <span class="comparison-separator">|</span>
                                        <span class="simulated-value" id="simulated-missed-demand">-</span>
                                        <span class="performance-indicator" id="missed-demand-indicator"></span>
                                    </div>
                                </div>
                                <div class="metric-line" id="stockout-days-line">
                                    <div class="metric-comparison">
                                        <span class="metric-label">Total Stockout Days:</span>
                                        <span class="actual-value" id="actual-stockout-days">-</span>
                                        <span class="comparison-separator">|</span>
                                        <span class="simulated-value" id="simulated-stockout-days">-</span>
                                        <span class="performance-indicator" id="stockout-days-indicator"></span>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="metric-line" id="overstocking-line">
                                    <div class="metric-comparison">
                                        <span class="metric-label">Overstocking %:</span>
                                        <span class="actual-value" id="actual-overstocking">-</span>
                                        <span class="comparison-separator">|</span>
                                        <span class="simulated-value" id="simulated-overstocking">-</span>
                                        <span class="performance-indicator" id="overstocking-indicator"></span>
                                    </div>
                                </div>
                                <div class="metric-line" id="understocking-line">
                                    <div class="metric-comparison">
                                        <span class="metric-label">Understocking %:</span>
                                        <span class="actual-value" id="actual-understocking">-</span>
                                        <span class="comparison-separator">|</span>
                                        <span class="simulated-value" id="simulated-understocking">-</span>
                                        <span class="performance-indicator" id="understocking-indicator"></span>
                                    </div>
                                </div>
                                <div class="metric-line" id="total-inventory-units-line">
                                    <div class="metric-comparison">
                                        <span class="metric-label">Total Inventory (Units):</span>
                                        <span class="actual-value" id="actual-total-inventory-units">-</span>
                                        <span class="comparison-separator">|</span>
                                        <span class="simulated-value" id="simulated-total-inventory-units">-</span>
                                        <span class="performance-indicator" id="total-inventory-units-indicator"></span>
                                    </div>
                                </div>
                                <div class="metric-line" id="total-inventory-cost-line">
                                    <div class="metric-comparison">
                                        <span class="metric-label">Total Inventory (Cost):</span>
                                        <span class="actual-value" id="actual-total-inventory-cost">-</span>
                                        <span class="comparison-separator">|</span>
                                        <span class="simulated-value" id="simulated-total-inventory-cost">-</span>
                                        <span class="performance-indicator" id="total-inventory-cost-indicator"></span>
                                    </div>
                                </div>
                                <div class="metric-line" id="inventory-difference-line">
                                    <div class="metric-comparison">
                                        <span class="metric-label">Inventory Difference %:</span>
                                        <span class="difference-value" id="inventory-difference">-</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Detailed Comparison Table -->
        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">Detailed Performance Comparison</h5>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-striped table-hover" id="comparisonTable">
                                <thead class="table-dark">
                                    <tr>
                                        <th>Product</th>
                                        <th>Location</th>
                                        <th>Method</th>
                                        <th colspan="2" class="text-center">Service Level (%)</th>
                                        <th colspan="2" class="text-center">Stockout Rate (%)</th>
                                        <th colspan="2" class="text-center">Inventory Days</th>
                                        <th colspan="2" class="text-center">Avg Inventory</th>
                                        <th colspan="2" class="text-center">Total Inventory (Units)</th>
                                        <th colspan="2" class="text-center">Total Inventory (Cost)</th>
                                        <th colspan="2" class="text-center">Stockout Days</th>
                                        <th colspan="2" class="text-center">Missed Demand</th>
                                        <th>Inventory Diff %</th>
                                    </tr>
                                    <tr>
                                        <th></th>
                                        <th></th>
                                        <th></th>
                                        <th class="text-success">Actual</th>
                                        <th class="text-info">Simulated</th>
                                        <th class="text-danger">Actual</th>
                                        <th class="text-warning">Simulated</th>
                                        <th class="text-primary">Actual</th>
                                        <th class="text-secondary">Simulated</th>
                                        <th class="text-success">Actual</th>
                                        <th class="text-info">Simulated</th>
                                        <th class="text-success">Actual</th>
                                        <th class="text-info">Simulated</th>
                                        <th class="text-danger">Actual</th>
                                        <th class="text-warning">Simulated</th>
                                        <th class="text-danger">Actual</th>
                                        <th class="text-warning">Simulated</th>
                                        <th class="text-danger">Actual</th>
                                        <th class="text-warning">Simulated</th>
                                        <th>Diff %</th>
                                    </tr>
                                </thead>
                                <tbody id="comparisonTableBody">
                                    <!-- Data will be populated by JavaScript -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    {% endif %}
</div>

<script>
document.getElementById('comparisonForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const formData = new FormData(this);
    
    // Show loading
    document.getElementById('loading').style.display = 'block';
    document.getElementById('resultsContainer').style.display = 'none';
    
    fetch('/get_comparison_data', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.error) {
            alert('Error: ' + data.error);
            return;
        }
        
        // Populate overall metrics
        if (data.overall_metrics) {
            // Helper function to determine if simulation is better
            function isSimulationBetter(actual, simulated, lowerIsBetter = false) {
                if (lowerIsBetter) {
                    return simulated < actual;
                }
                return simulated > actual;
            }
            
            // Helper function to apply highlighting
            function applyHighlighting(lineId, actual, simulated, lowerIsBetter = false, indicatorId = null) {
                const line = document.getElementById(lineId);
                const isBetter = isSimulationBetter(actual, simulated, lowerIsBetter);
                
                // Remove existing classes
                line.classList.remove('simulation-better', 'actual-better');
                
                // Apply appropriate class
                if (isBetter) {
                    line.classList.add('simulation-better');
                } else {
                    line.classList.add('actual-better');
                }
                
                // Update performance indicator if provided
                if (indicatorId) {
                    const indicator = document.getElementById(indicatorId);
                    if (isBetter) {
                        indicator.textContent = 'Better';
                        indicator.className = 'performance-indicator performance-better';
                    } else {
                        indicator.textContent = 'Worse';
                        indicator.className = 'performance-indicator performance-worse';
                    }
                }
            }
            
            // Update values and apply highlighting
            document.getElementById('actual-service-level').textContent = data.overall_metrics.avg_actual_service_level + '%';
            document.getElementById('simulated-service-level').textContent = data.overall_metrics.avg_simulated_service_level + '%';
            applyHighlighting('service-level-line', data.overall_metrics.avg_actual_service_level, data.overall_metrics.avg_simulated_service_level, false, 'service-level-indicator');
            
            document.getElementById('actual-stockout-rate').textContent = data.overall_metrics.avg_actual_stockout_rate + '%';
            document.getElementById('simulated-stockout-rate').textContent = data.overall_metrics.avg_simulated_stockout_rate + '%';
            applyHighlighting('stockout-rate-line', data.overall_metrics.avg_actual_stockout_rate, data.overall_metrics.avg_simulated_stockout_rate, true, 'stockout-rate-indicator');
            
            document.getElementById('actual-inventory-days').textContent = data.overall_metrics.avg_actual_inventory_days;
            document.getElementById('simulated-inventory-days').textContent = data.overall_metrics.avg_simulated_inventory_days;
            applyHighlighting('inventory-days-line', data.overall_metrics.avg_actual_inventory_days, data.overall_metrics.avg_simulated_inventory_days, true, 'inventory-days-indicator');
            
            document.getElementById('actual-missed-demand').textContent = data.overall_metrics.total_actual_missed_demand.toLocaleString();
            document.getElementById('simulated-missed-demand').textContent = data.overall_metrics.total_simulated_missed_demand.toLocaleString();
            applyHighlighting('missed-demand-line', data.overall_metrics.total_actual_missed_demand, data.overall_metrics.total_simulated_missed_demand, true, 'missed-demand-indicator');
            
            document.getElementById('actual-stockout-days').textContent = data.overall_metrics.total_actual_stockout_days;
            document.getElementById('simulated-stockout-days').textContent = data.overall_metrics.total_simulated_stockout_days;
            applyHighlighting('stockout-days-line', data.overall_metrics.total_actual_stockout_days, data.overall_metrics.total_simulated_stockout_days, true, 'stockout-days-indicator');
            
            document.getElementById('actual-total-inventory-units').textContent = data.overall_metrics.total_actual_inventory_units.toLocaleString();
            document.getElementById('simulated-total-inventory-units').textContent = data.overall_metrics.total_simulated_inventory_units.toLocaleString();
            applyHighlighting('total-inventory-units-line', data.overall_metrics.total_actual_inventory_units, data.overall_metrics.total_simulated_inventory_units, true, 'total-inventory-units-indicator');
            
            document.getElementById('actual-total-inventory-cost').textContent = data.overall_metrics.total_actual_inventory_cost.toLocaleString();
            document.getElementById('simulated-total-inventory-cost').textContent = data.overall_metrics.total_simulated_inventory_cost.toLocaleString();
            applyHighlighting('total-inventory-cost-line', data.overall_metrics.total_actual_inventory_cost, data.overall_metrics.total_simulated_inventory_cost, true, 'total-inventory-cost-indicator');
            
            document.getElementById('actual-overstocking').textContent = data.overall_metrics.avg_actual_overstocking_percentage + '%';
            document.getElementById('simulated-overstocking').textContent = data.overall_metrics.avg_simulated_overstocking_percentage + '%';
            applyHighlighting('overstocking-line', data.overall_metrics.avg_actual_overstocking_percentage, data.overall_metrics.avg_simulated_overstocking_percentage, true, 'overstocking-indicator');
            
            document.getElementById('actual-understocking').textContent = data.overall_metrics.avg_actual_understocking_percentage + '%';
            document.getElementById('simulated-understocking').textContent = data.overall_metrics.avg_simulated_understocking_percentage + '%';
            applyHighlighting('understocking-line', data.overall_metrics.avg_actual_understocking_percentage, data.overall_metrics.avg_simulated_understocking_percentage, true, 'understocking-indicator');
            
            document.getElementById('inventory-difference').textContent = data.overall_metrics.avg_inventory_difference_percentage + '%';
            document.getElementById('inventory-difference').className = 'difference-value ' + (Math.abs(data.overall_metrics.avg_inventory_difference_percentage) < 10 ? 'text-success' : 'text-warning');
        }
        
        // Populate detailed table
        const tableBody = document.getElementById('comparisonTableBody');
        tableBody.innerHTML = '';
        
        data.comparison_results.forEach(result => {
            const row = document.createElement('tr');
            row.innerHTML = `
                <td>${result.product_id}</td>
                <td>${result.location_id}</td>
                <td>${result.forecast_method}</td>
                <td class="text-success">${result.actual_service_level}%</td>
                <td class="text-info">${result.simulated_service_level}%</td>
                <td class="text-danger">${result.actual_stockout_rate}%</td>
                <td class="text-warning">${result.simulated_stockout_rate}%</td>
                <td class="text-primary">${result.actual_inventory_days}</td>
                <td class="text-secondary">${result.simulated_inventory_days}</td>
                <td class="text-success">${result.actual_avg_inventory.toLocaleString()}</td>
                <td class="text-info">${result.simulated_avg_inventory.toLocaleString()}</td>
                <td class="text-success">${result.actual_total_inventory_units.toLocaleString()}</td>
                <td class="text-info">${result.simulated_total_inventory_units.toLocaleString()}</td>
                <td class="text-danger">${result.actual_total_inventory_cost.toLocaleString()}</td>
                <td class="text-warning">${result.simulated_total_inventory_cost.toLocaleString()}</td>
                <td class="text-danger">${result.actual_stockout_days}</td>
                <td class="text-warning">${result.simulated_stockout_days}</td>
                <td class="text-danger">${result.actual_missed_demand.toLocaleString()}</td>
                <td class="text-warning">${result.simulated_missed_demand.toLocaleString()}</td>
                <td class="${Math.abs(result.inventory_difference_percentage) < 10 ? 'text-success' : 'text-warning'}">${result.inventory_difference_percentage}%</td>
            `;
            tableBody.appendChild(row);
        });
        
        // Hide loading and show results
        document.getElementById('loading').style.display = 'none';
        document.getElementById('resultsContainer').style.display = 'block';
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error generating comparison');
        document.getElementById('loading').style.display = 'none';
    });
});

// Auto-submit on page load
document.addEventListener('DOMContentLoaded', function() {
    document.getElementById('comparisonForm').dispatchEvent(new Event('submit'));
});
</script>
{% endblock %} 